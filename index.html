<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>評価ルート＆評価ポイントビューワ（自車位置→走行軌跡→走行ルート の順）</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="stylesheet" href="leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .control-bar {
      position: absolute; z-index: 1000; left: 10px; top: 10px;
      background: rgba(255,255,255,.95); border-radius: 12px; padding: 10px; box-shadow: 0 2px 10px rgba(0,0,0,.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
    }
    .control-bar h3 { margin: 0 0 8px; font-size: 14px; }
    .control-bar .row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
    .control-bar label { font-size: 12px; }
    .legend {
      position: absolute; z-index: 1000; right: 10px; bottom: 10px;
      background: rgba(255,255,255,.95); border-radius: 12px; padding: 10px; box-shadow: 0 2px 10px rgba(0,0,0,.15);
      font-size: 12px;
    }
    .legend-item { display: flex; align-items: center; gap: 8px; margin: 4px 0; }
    .swatch { width: 26px; height: 6px; border-radius: 3px; background: #000; }
    .swatch.track { background: #22c55e; border: 2px solid #15803d; height: 0; border-radius: 999px; }
    .swatch.route { background: #3b82f6; height: 8px; }
    .swatch.me { width: 10px; height: 10px; border-radius: 999px; background: #ef4444; }

    /* Leaflet pane z-index 説明: markerPane=600, overlayPane=400 が既定 */
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="control-bar">
    <h3>データ読込</h3>
    <div class="row">
      <input type="file" id="fileInput" accept=".gpx,.geojson,.json,.kml,.kmz" multiple>
    </div>
    <div class="row">
      <button id="startTrack">追跡開始</button>
      <button id="stopTrack" disabled>追跡停止</button>
      <button id="clearTrack">軌跡クリア</button>
    </div>
    <div class="row">
      <label><input type="checkbox" id="followMe" checked> 自車追従</label>
    </div>
  </div>

  <div class="legend">
    <div class="legend-item"><span class="swatch me"></span><span>自車位置（最前面）</span></div>
    <div class="legend-item"><span class="swatch track"></span><span>走行軌跡（細）</span></div>
    <div class="legend-item"><span class="swatch route"></span><span>走行ルート（太）</span></div>
  </div>

  <script src="leaflet.js"></script>
  <script src="jszip.min.js"></script>
  <script src="togeojson.umd.js"></script>
  <script>
    // --- マップ初期化 --------------------------------------------------------
    const map = L.map('map', { zoomControl: true }).setView([35.681, 139.767], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // --- Pane の設定: 走行軌跡を overlayPane より上、markerPane より下に ---------
    map.createPane('trackPane');
    map.getPane('trackPane').style.zIndex = 450; // overlayPane=400 < 450 < markerPane=600

    // --- レイヤグループ ------------------------------------------------------
    const routeLayer = L.layerGroup().addTo(map);             // 走行ルート（overlayPane=400既定）
    const trackLayer = L.layerGroup({ pane: 'trackPane' }).addTo(map); // 走行軌跡（z=450）
    const markerLayer = L.layerGroup().addTo(map);            // 評価ポイントなど（markerPane=600）

    // --- スタイル定義 --------------------------------------------------------
    const ROUTE_STYLE = {
      color: '#3b82f6',       // 青
      weight: 6,              // 走行ルートは太め
      opacity: 0.9
    };

    const TRACK_STYLE = {
      color: '#22c55e',       // 明るい緑（本線）
      weight: 3,              // 走行軌跡は細め
      opacity: 1,
      pane: 'trackPane'
    };

    const TRACK_CASING_STYLE = {
      color: '#15803d',       // 濃い緑（視認性向上用ケーシング）
      weight: 7,
      opacity: 0.35,
      pane: 'trackPane'
    };

    // --- 自車位置 ------------------------------------------------------------
    let watchId = null;
    let lastPos = null;
    let meMarker = null;
    let trackCasingLine = null;
    let trackMainLine = null;
    const trackCoords = []; // [[lat,lng], ...]

    function ensureMeMarker(latlng) {
      if (!meMarker) {
        meMarker = L.circleMarker(latlng, {
          radius: 7,
          fillColor: '#ef4444', // 赤
          color: '#7f1d1d',
          weight: 2,
          fillOpacity: 1
        }).addTo(markerLayer); // markerPane=600 → 最上位
      } else {
        meMarker.setLatLng(latlng);
      }
    }

    function updateTrack(latlng) {
      trackCoords.push([latlng.lat, latlng.lng]);
      // ケーシング（太）→ 本線（細）の順で描く（同一 pane の中でも後勝ちで重なる）
      if (trackCasingLine) trackLayer.removeLayer(trackCasingLine);
      if (trackMainLine)   trackLayer.removeLayer(trackMainLine);
      trackCasingLine = L.polyline(trackCoords, TRACK_CASING_STYLE).addTo(trackLayer);
      trackMainLine   = L.polyline(trackCoords, TRACK_STYLE).addTo(trackLayer);
    }

    function startTracking() {
      if (watchId !== null) return;
      document.getElementById('startTrack').disabled = true;
      document.getElementById('stopTrack').disabled = false;

      watchId = navigator.geolocation.watchPosition(pos => {
        const latlng = L.latLng(pos.coords.latitude, pos.coords.longitude);
        lastPos = latlng;
        ensureMeMarker(latlng); // 自車位置（最上位）
        updateTrack(latlng);    // 走行軌跡（中位）
        if (document.getElementById('followMe').checked) {
          map.setView(latlng, Math.max(map.getZoom(), 15));
        }
      }, err => {
        alert('位置情報の取得に失敗: ' + err.message);
      }, { enableHighAccuracy: true, maximumAge: 1000, timeout: 20000 });
    }

    function stopTracking() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        document.getElementById('startTrack').disabled = false;
        document.getElementById('stopTrack').disabled = true;
      }
    }

    function clearTrack() {
      trackCoords.length = 0;
      if (trackCasingLine) { trackLayer.removeLayer(trackCasingLine); trackCasingLine = null; }
      if (trackMainLine)   { trackLayer.removeLayer(trackMainLine);   trackMainLine   = null; }
    }

    document.getElementById('startTrack').addEventListener('click', startTracking);
    document.getElementById('stopTrack').addEventListener('click', stopTracking);
    document.getElementById('clearTrack').addEventListener('click', clearTrack);

    // --- ファイル読込: GPX/KML/KMZ/GeoJSON ---------------------------------
    const fileInput = document.getElementById('fileInput');
    fileInput.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files || []);
      for (const file of files) {
        try {
          await loadFileAsLayer(file);
        } catch (err) {
          console.error(err);
          alert(`${file.name} の読み込みに失敗しました: ${err.message}`);
        }
      }
    });

    async function loadFileAsLayer(file) {
      const ext = file.name.toLowerCase().split('.').pop();
      if (ext === 'gpx') {
        const text = await file.text();
        const xml = new DOMParser().parseFromString(text, 'text/xml');
        const gj = togeojson.gpx(xml); // GeoJSON
        renderGeoJSONAsRoute(gj, file.name);
      } else if (ext === 'kml') {
        const text = await file.text();
        const xml = new DOMParser().parseFromString(text, 'text/xml');
        const gj = togeojson.kml(xml); // GeoJSON
        renderGeoJSONAsRoute(gj, file.name);
      } else if (ext === 'kmz') {
        await handleKMZ(file);
      } else if (ext === 'geojson' || ext === 'json') {
        const text = await file.text();
        const gj = JSON.parse(text);
        renderGeoJSONAsRoute(gj, file.name);
      } else {
        throw new Error('未対応の拡張子です');
      }
    }

    async function handleKMZ(file) {
      // KMZ を解凍し、含まれるすべての .kml を統合して描画する（styles 有効）
      let zip;
      try {
        const buf = await file.arrayBuffer();
        zip = await JSZip.loadAsync(buf);
      } catch (e) {
        throw new Error('KMZ を解凍できません（壊れているか、KMZ ではない可能性）');
      }

      const entries = Object.values(zip.files).filter(f => !f.dir && f.name.toLowerCase().endsWith('.kml'));
      if (entries.length === 0) {
        throw new Error('KMZ 内に KML が見つかりません（doc.kml が入っているか確認）');
      }

      // すべての KML をパース → GeoJSON に変換 → マージ
      const merged = { type: 'FeatureCollection', features: [] };
      for (const ent of entries) {
        const kmlText = await ent.async('string');
        const xml = new DOMParser().parseFromString(kmlText, 'text/xml');
        // XML パースエラーチェック
        const pe = xml.getElementsByTagName('parsererror')[0];
        if (pe) {
          console.warn('KML の XML パースに失敗: ', ent.name, pe.textContent);
          continue;
        }
        // スタイル情報を活かして GeoJSON 化
        let gj;
        try {
          gj = togeojson.kml(xml, { styles: true });
        } catch (e) {
          console.warn('toGeoJSON 変換に失敗: ', ent.name, e);
          continue;
        }
        if (gj && Array.isArray(gj.features)) {
          merged.features.push(...gj.features);
        }
      }

      if (!merged.features.length) {
        throw new Error('KML を GeoJSON に変換できません（gx:Track 非対応の古い togeojson でないか確認）');
      }

      renderGeoJSONAsRoute(merged, file.name);
    }

    function renderGeoJSONAsRoute(geojson, label = 'route') {
      const bounds = L.geoJSON(geojson).getBounds();
      // ルートは overlayPane（既定）に描画（=最下位）
      L.geoJSON(geojson, {
        style: feature => {
          if (feature.geometry && feature.geometry.type && feature.geometry.type.includes('Line')) {
            return ROUTE_STYLE; // 太い青線
          }
          return { color: '#6b7280', weight: 2, opacity: .9 };
        },
        pointToLayer: (feat, latlng) => {
          // 評価ポイント等（マーカーは markerPane=600 で最上位）
          return L.circleMarker(latlng, {
            radius: 5, color: '#1f2937', weight: 2, fillColor: '#f59e0b', fillOpacity: 0.9
          }).bindTooltip(feat.properties?.name || label, { direction: 'top' });
        }
      }).addTo(routeLayer);

      if (bounds.isValid()) map.fitBounds(bounds.pad(0.1));
    }

    // --- PWA（任意） ---------------------------------------------------------
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(console.warn);
    }
  </script>
</body>
</html>
