<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>実車評価支援ツール</title>
<link rel="stylesheet" href="leaflet.css" />
<style>
  html,body{height:100%;margin:0}
  #map{position:fixed; inset:0; background:#f2f2f2; transform-origin:center center; z-index:0;}
  #panel{
    position:fixed; left:10px; top:calc(10px + env(safe-area-inset-top));
    z-index:2147483000; background:#fff; padding:10px 12px; border-radius:12px;
    box-shadow:0 6px 24px rgba(0,0,0,.18); font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
    min-width:300px; max-width:min(94vw,560px)
  }
  #panel h1{margin:0 0 8px;font-size:15px;font-weight:700}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0}
  .row>label{white-space:nowrap}
  .small{font-size:11px;color:#555}
  .grow{flex:1 1 auto;min-width:140px}
  button{padding:10px 14px; min-height:40px; border-radius:12px; cursor:pointer; border:1px solid #ddd; background:#fff;}
  select, input[type=range]{height:40px;border-radius:10px;border:1px solid #ddd;padding:0 8px}
  #start{background:#16a34a;color:#fff;border-color:#16a34a}
  #stop{background:#ef4444;color:#fff;border-color:#ef4444}
  #recenter{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
  #cp{background:#f59e0b;color:#fff;border-color:#f59e0b}
  #saveGpx{background:#6366f1;color:#fff;border-color:#6366f1}
  #fabStop{position:fixed; right:calc(12px + env(safe-area-inset-right)); bottom:calc(12px + env(safe-area-inset-bottom));
    z-index:2147483200; display:none; width:84px;height:84px;border-radius:50%; box-shadow:0 12px 36px rgba(0,0,0,.28);
    border:none; background:#ef4444;color:#fff;font-size:16px;font-weight:700;}
  #recBadge{position:fixed; right:12px; top:calc(12px + env(safe-area-inset-top)); z-index:2147483200; display:none; align-items:center; gap:6px;
    background:rgba(239,68,68,.95); color:#fff; padding:6px 10px; border-radius:9999px; box-shadow:0 6px 24px rgba(0,0,0,.18); font-size:12px}
  .dot{width:10px;height:10px;border-radius:50%;background:#fff;animation:blink 1s infinite}
  @keyframes blink{0%,60%{opacity:1}61%,100%{opacity:.25}}
  #toast{position:fixed; left:50%; bottom:calc(78px + env(safe-area-inset-bottom)); transform:translateX(-50%); z-index:2147483200;
    display:flex; align-items:center; gap:8px; background:rgba(0,0,0,.75); backdrop-filter:blur(8px); padding:8px 16px; border-radius:9999px;
    color:#fff; min-width:180px; max-width:90vw; opacity:0; pointer-events:none; transition:opacity .2s;}
  #togglePanel{position:fixed; right:10px; top:calc(10px + env(safe-area-inset-top)); z-index:2147483000;
    background:#fff; padding:10px 12px; border-radius:12px;
    box-shadow:0 6px 24px rgba(0,0,0,.18);
    cursor:pointer;
  }
</style>
<link rel="manifest" href="manifest.webmanifest" />
<link rel="apple-touch-icon" href="icons/icon-512.png" />
<link rel="shortcut icon" href="icons/icon-512.png" type="image/x-icon" />
<script src="leaflet.js"></script>
<script src="jszip.min.js"></script>
<script src="togeojson.umd.js"></script>
</head>
<body>
<div id="map"></div>
<div id="panel">
  <h1>実車評価支援ツール</h1>
  <div class="row">
    <label for="kmlFile" class="grow">KML/KMZファイル</label>
    <input type="file" id="kmlFile" accept=".kml,.kmz" />
  </div>
  <div class="row">
    <label for="speedRange" class="grow">音声通知速度(km/h)</label>
    <input type="range" id="speedRange" value="60" min="0" max="120" step="5" class="grow" />
    <span id="speedValue">60</span>
  </div>
  <div class="row">
    <label for="alertRange" class="grow">音声通知距離(m)</label>
    <input type="range" id="alertRange" value="100" min="10" max="300" step="10" class="grow" />
    <span id="alertValue">100</span>
  </div>
  <div class="row">
    <label for="evaluationPoints" class="grow">評価ポイント</label>
    <select id="evaluationPoints" class="grow"></select>
  </div>
  <div class="row">
    <button id="recenter" class="grow">現在地へ</button>
    <button id="cp" class="grow">評価ポイント記録</button>
  </div>
  <div class="row">
    <button id="start" class="grow">位置追跡を開始</button>
    <button id="stop" class="grow" disabled>位置追跡を終了</button>
  </div>
  <div class="row">
    <button id="saveGpx" class="grow">GPXを保存</button>
  </div>
  <p class="small">
    ※GPXファイルは評価ポイントも併せて記録されます。<br />
    ※本ツールは位置情報を活用するため、正確な評価にはGPSの精度が重要です。
  </p>
</div>

<button id="togglePanel">メニュー</button>
<button id="fabStop">終了</button>
<div id="recBadge">
  <div class="dot"></div>
  REC
</div>
<div id="toast"></div>

<script>
  // グローバル変数
  let map, currentMarker, pathLine, evaluationPointsLayer;
  let watchId = null;
  let trackData = [];
  const MAX_CHECKPOINTS = 50;

  // 初期化
  function initMap() {
    map = L.map('map', {
      center: [35.658034, 139.701636], // Shibuya default
      zoom: 13,
      zoomControl: false,
      attributionControl: false,
    });
    L.control.zoom({ position: 'topright' }).addTo(map);
    L.control.attribution({ position: 'bottomleft', prefix: '<a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a>' }).addTo(map);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      subdomains: ['a', 'b', 'c']
    }).addTo(map);

    pathLine = L.polyline([], { color: '#ef4444', weight: 4 }).addTo(map);
    evaluationPointsLayer = L.layerGroup().addTo(map);
  }

  // 位置情報取得成功時の処理
  function onPositionSuccess(position) {
    const { latitude, longitude } = position.coords;
    const latlng = [latitude, longitude];

    if (!currentMarker) {
      currentMarker = L.marker(latlng).addTo(map);
      map.setView(latlng, 17);
    } else {
      currentMarker.setLatLng(latlng);
    }

    pathLine.addLatLng(latlng);
    trackData.push({
      lat: latitude,
      lon: longitude,
      ele: position.coords.altitude || null,
      time: new Date(position.timestamp).toISOString(),
      evaluation: null
    });

    map.setView(latlng);
  }

  // 位置情報取得失敗時の処理
  function onPositionError(error) {
    showToast(`位置情報取得エラー: ${error.message}`);
  }

  // ルートファイルを読み込み、評価ポイントを表示
  function loadFile(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const parser = new DOMParser();
        const xml = parser.parseFromString(e.target.result, 'text/xml');
        let geojson;
        if (file.name.toLowerCase().endsWith('.kml')) {
          geojson = toGeoJSON.kml(xml);
        } else if (file.name.toLowerCase().endsWith('.kmz')) {
          const zip = new JSZip();
          zip.loadAsync(e.target.result).then(function(zip) {
            const kmlFile = Object.keys(zip.files).find(name => name.toLowerCase().endsWith('.kml'));
            if (!kmlFile) throw new Error('KMZファイル内にKMLファイルが見つかりません。');
            zip.file(kmlFile).async('string').then(function(kmlString) {
              const kmlXml = parser.parseFromString(kmlString, 'text/xml');
              geojson = toGeoJSON.kml(kmlXml);
              displayGeoJSON(geojson);
            });
          });
          return;
        } else {
          showToast('サポートされていないファイル形式です。KMLまたはKMZファイルを選択してください。');
          return;
        }
        displayGeoJSON(geojson);
      } catch (error) {
        showToast(`ファイル処理エラー: ${error.message}`);
      }
    };
    reader.readAsArrayBuffer(file);
  }

  function displayGeoJSON(geojson) {
    // 既存の評価ポイントをクリア
    evaluationPointsLayer.clearLayers();
    const evaluationPoints = document.getElementById('evaluationPoints');
    evaluationPoints.innerHTML = '';

    const points = geojson.features.filter(f => f.geometry.type === 'Point' && f.properties.name);
    points.forEach(point => {
      const option = document.createElement('option');
      option.value = point.properties.name;
      option.text = point.properties.name;
      evaluationPoints.appendChild(option);
      const marker = L.marker([point.geometry.coordinates[1], point.geometry.coordinates[0]], {
        title: point.properties.name
      }).addTo(evaluationPointsLayer);
    });

    if (points.length > 0) {
      const bounds = L.geoJSON(geojson).getBounds();
      map.fitBounds(bounds);
    }
  }

  // GPXファイル作成
  function createGpxFile() {
    if (trackData.length === 0) {
      showToast('記録された軌跡がありません。');
      return;
    }

    let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx xmlns="http://www.topografix.com/GPX/1/1" version="1.1" creator="RouteAid">
<trk>
<trkseg>`;
    trackData.forEach(p => {
      gpx += `
<trkpt lat="${p.lat}" lon="${p.lon}">
  <time>${p.time}</time>${p.ele ? `\n  <ele>${p.ele.toFixed(2)}</ele>` : ''}${p.evaluation ? `\n  <extensions><evaluation>${p.evaluation}</evaluation></extensions>` : ''}
</trkpt>`;
    });

    gpx += `
</trkseg>
</trk>
</gpx>`;

    return gpx;
  }

  // ファイル保存
  function saveFile(text, name, type) {
    try {
      const blob = new Blob([text], { type: type });
      // 1) IE/Edge 対応
      if (navigator.msSaveBlob) {
        navigator.msSaveBlob(blob, name);
        return;
      }

      // 2) 新規タブで開いて iOS のアクションメニューへ
      const url = URL.createObjectURL(blob);
      const opened = window.open(url, '_blank');
      if (!opened) {
        // 3) download属性でのダウンロード
        const a = document.createElement('a');
        a.href = url; a.download = name;
        document.body.appendChild(a); a.click(); a.remove();
      }
      setTimeout(()=>URL.revokeObjectURL(url), 4000);
    }catch(e){
      const win = window.open('', '_blank');
      if (win){
        win.document.open();
        win.document.write(`<pre style="white-space:pre-wrap;word-break:break-all;">${escapeHTML(text)}</pre>`);
        win.document.close();
      }else{
        alert('保存に失敗しました。ポップアップブロックを解除して再試行してください。');
      }
    }
  }

  function escapeHTML(str){
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // Toast表示
  function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.style.opacity = 1;
    setTimeout(() => {
      toast.style.opacity = 0;
    }, 3000);
  }

  // イベントリスナー
  document.getElementById('start').addEventListener('click', () => {
    document.getElementById('start').disabled = true;
    document.getElementById('stop').disabled = false;
    document.getElementById('fabStop').style.display = 'block';
    document.getElementById('recBadge').style.display = 'flex';
    trackData = [];
    watchId = navigator.geolocation.watchPosition(onPositionSuccess, onPositionError, {
      enableHighAccuracy: true
    });
  });

  document.getElementById('stop').addEventListener('click', () => {
    if (confirm('評価を終了してGPXファイルを保存しますか？')) {
      const fileName = prompt('保存するファイル名を入力してください:', 'track-' + new Date().toISOString().split('T')[0] + '.gpx');
      if (fileName) {
        const gpxData = createGpxFile();
        saveFile(gpxData, fileName, 'application/gpx+xml');
      }
    }
    
    document.getElementById('start').disabled = false;
    document.getElementById('stop').disabled = true;
    document.getElementById('fabStop').style.display = 'none';
    document.getElementById('recBadge').style.display = 'none';
    if (watchId !== null) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }
    showToast('位置追跡を停止しました。');
  });

  document.getElementById('fabStop').addEventListener('click', () => {
    document.getElementById('stop').click();
  });

  document.getElementById('recenter').addEventListener('click', () => {
    if (currentMarker) {
      map.setView(currentMarker.getLatLng(), 17);
    }
  });

  document.getElementById('kmlFile').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      loadFile(file);
    }
  });

  document.getElementById('cp').addEventListener('click', () => {
    if (currentMarker) {
      const cpName = document.getElementById('evaluationPoints').value;
      if (trackData.length > 0 && cpName) {
        trackData[trackData.length - 1].evaluation = cpName;
        showToast(`評価ポイント「${cpName}」を記録しました。`);
      } else {
        showToast('評価ポイントを選択するか、位置追跡を開始してください。');
      }
    }
  });
  
  document.getElementById('speedRange').addEventListener('input', (e) => {
    document.getElementById('speedValue').textContent = e.target.value;
  });

  document.getElementById('alertRange').addEventListener('input', (e) => {
    document.getElementById('alertValue').textContent = e.target.value;
  });

  document.getElementById('saveGpx').addEventListener('click', () => {
    const fileName = prompt('保存するファイル名を入力してください:', 'route-' + new Date().toISOString().split('T')[0] + '.gpx');
    if (fileName) {
      const gpxData = createGpxFile();
      saveFile(gpxData, fileName, 'application/gpx+xml');
    }
  });

  document.getElementById('togglePanel').addEventListener('click', () => {
    const panel = document.getElementById('panel');
    if (panel.style.display === 'none') {
      panel.style.display = 'block';
    } else {
      panel.style.display = 'none';
    }
  });

  // 初期化実行
  initMap();

  /* ==== サービスワーカー（即時更新） ==== */
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js').then(reg=>{
      if(reg.waiting){ reg.waiting.postMessage({type:'SKIP_WAITING'}); }
      reg.addEventListener('updatefound',()=>{\n        const sw=reg.installing; sw?.addEventListener('statechange',()=>{\n          if(sw.state==='installed'){ reg.waiting?.postMessage({type:'SKIP_WAITING'}); }
        });
      });
    }).catch(e=>console.error('SW登録失敗',e));

    navigator.serviceWorker.addEventListener('message', e=>{
      if(e.data && e.data.type === 'REFRESH'){ location.reload(); }
    });
  }
</script>
</body>
</html>
