<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>実車評価支援ツール</title>
<link rel="stylesheet" href="leaflet.css" />
<style>
  html,body{height:100%;margin:0}
  #map{position:fixed; inset:0; background:#f2f2f2; transform-origin:center center; z-index:0;}
  #panel{
    position:fixed; left:10px; top:calc(10px + env(safe-area-inset-top));
    z-index:2147483000; background:#fff; padding:10px 12px; border-radius:12px;
    box-shadow:0 6px 24px rgba(0,0,0,.18); font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
    min-width:300px; max-width:min(94vw,560px);
    transition: transform 0.3s ease-in-out;
  }
  .panel-hidden { transform: translateX(-110%); }
  #panel h1{margin:0 0 8px;font-size:15px;font-weight:700}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0}
  .row>label{white-space:nowrap}
  .small{font-size:11px;color:#555}
  .grow{flex:1 1 auto;min-width:140px}
  button{padding:10px 14px; min-height:40px; border-radius:12px; cursor:pointer; border:1px solid #ddd; background:#fff;}
  select, input[type=range]{height:40px;border-radius:10px;border:1px solid #ddd;padding:0 8px}
  #start{background:#16a34a;color:#fff;border-color:#16a34a}
  #recenter{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
  #cp{background:#f59e0b;color:#fff;border-color:#f59e0b}
  #saveGpx{background:#6366f1;color:#fff;border-color:#6366f1}
  #fabStop{position:fixed; right:calc(12px + env(safe-area-inset-right)); bottom:calc(12px + env(safe-area-inset-bottom));
    z-index:2147483200; display:none; width:84px;height:84px;border-radius:50%; box-shadow:0 12px 36px rgba(0,0,0,.28);
    border:none; background:#ef4444;color:#fff;font-size:16px;font-weight:700;}
  #toast{position:fixed; left:50%; bottom:calc(78px + env(safe-area-inset-bottom)); transform:translateX(-50%); z-index:2147483100;
    display:none; max-width:min(92vw,560px); background:rgba(0,0,0,.85); color:#fff; padding:10px 14px; border-radius:12px;
    box-shadow:0 6px 24px rgba(0,0,0,.35); font-size:14px}
</style>
</head>
<body>
<div id="map"></div>

<div id="panel">
  <h1>実車評価支援ツール</h1>

  <div class="row">
    <input type="file" id="file" accept=".kml,.kmz" multiple />
    <select id="datasetSelect" class="grow">
      <option value="" disabled selected>（読み込んだルート／ポイントを選択）</option>
    </select>
    <span id="fname" class="small"></span>
  </div>

  <div class="row">
    <button id="start">追跡開始</button>
    <button id="recenter">現在地へ</button>
    <button id="cp" disabled>チェックポイント</button>
  </div>

  <div class="row">
    <label><input type="checkbox" id="keepCentered" checked />自車を常に中心</label>
    <label style="margin-left:10px">向き:</label>
    <label><input type="radio" name="orient" value="north" checked />北を上</label>
    <label><input type="radio" name="orient" value="course" />進行方向を上</label>
  </div>
</div>

<button id="fabStop">STOP</button>
<div id="toast"></div>

<script src="leaflet.js"></script>
<script src="jszip.min.js"></script>
<script src="togeojson.umd.js"></script>
<script>
// === 地図初期化 ===
const map = L.map('map').setView([35.3, 139.2], 13);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

let datasets = [];
let currentDataset = null;
let currentPosMarker = null;
let notifiedPoints = new Set();
let notifyRadius = 80; // m

// === ファイル読み込み ===
document.getElementById('file').addEventListener('change', async e => {
  for(const file of e.target.files){
    let text;
    if(file.name.endsWith(".kmz")){
      const zip = await JSZip.loadAsync(file);
      const kmlFile = Object.keys(zip.files).find(f => f.endsWith(".kml"));
      text = await zip.files[kmlFile].async("string");
    } else {
      text = await file.text();
    }
    const kml = new DOMParser().parseFromString(text,"text/xml");
    const geojson = toGeoJSON.kml(kml);

    // === Point のみ抽出し、name が無ければ補完 ===
    const points = geojson.features.filter(f => f.geometry?.type === "Point");
    points.forEach((p,i)=>{
      if(!p.properties.name) p.properties.name = `チェックポイント${i+1}`;
    });

    const layer = L.geoJSON(points).addTo(map);
    datasets.push({name:file.name,layer,points});
    const opt = document.createElement("option");
    opt.value = file.name; opt.textContent = file.name;
    document.getElementById('datasetSelect').appendChild(opt);
  }
});

// === 音声読み上げ ===
function speak(text){
  if(!text) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "ja-JP";
  speechSynthesis.speak(u);
  showToast(text);
}

function showToast(msg){
  const toast=document.getElementById("toast");
  toast.textContent=msg;
  toast.style.display="block";
  setTimeout(()=>toast.style.display="none",3000);
}

// === 現在地追跡 ===
document.getElementById("start").addEventListener("click",()=>{
  if(!navigator.geolocation){alert("GPS未対応");return;}
  navigator.geolocation.watchPosition(pos=>{
    const lat=pos.coords.latitude, lon=pos.coords.longitude;
    if(!currentPosMarker){
      currentPosMarker=L.marker([lat,lon]).addTo(map);
    } else {
      currentPosMarker.setLatLng([lat,lon]);
    }
    if(document.getElementById("keepCentered").checked){
      map.setView([lat,lon], map.getZoom());
    }
    // 開始直後にも範囲内チェック
    checkProximity([lon,lat], true);
  }, err=>console.error(err),{enableHighAccuracy:true});
});

// === 範囲チェック ===
function checkProximity(lonlat, initial=false){
  if(!currentDataset) return;
  const [lon,lat] = lonlat;
  let insidePoints = [];
  currentDataset.points.forEach((p,i)=>{
    const [plon,plat] = p.geometry.coordinates;
    const dist = haversine(lat,lon,plat,plon);
    if(dist<notifyRadius && !notifiedPoints.has(i)){
      insidePoints.push({i,dist,name:p.properties.name});
    }
  });
  // 初期位置なら近い順に全部読み上げ
  if(initial){
    insidePoints.sort((a,b)=>a.dist-b.dist);
  } else {
    insidePoints = insidePoints.slice(0,1);
  }
  insidePoints.forEach(pt=>{
    notifiedPoints.add(pt.i);
    speak(pt.name);
  });
}

// === データセット選択 ===
document.getElementById("datasetSelect").addEventListener("change",e=>{
  const ds = datasets.find(d=>d.name===e.target.value);
  currentDataset = ds;
  notifiedPoints.clear();
});

// === 距離計算 ===
function haversine(lat1,lon1,lat2,lon2){
  const R=6371000;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
</script>
</body>
</html>
